/**
 * jQuery Sina Emotion
 * @author [Jealous](http://www.clanfei.com/)
 * @license MIT
 */
!function(e,t){"object"==typeof module&&"object"==typeof module.exports?t(require("jquery")):t(e.jQuery)}(this,function(e){"use strict";var t,i,a=1,n=2,s=[],o={},c=[],r={},l="默认",u=0;function f(f){if(u!==n)if(u!==a){f&&s.push(f),u=a,i=i||e.fn.sinaEmotion.options;var d,m=e('<div id="sina-emotion">正在加载，请稍后...</div>');e("body").append(m),d=e("#sina-emotion"),e("body").bind({click:function(){d.hide()}}),d.bind({click:function(e){e.stopPropagation()}}).delegate(".prev",{click:function(e){h(d.find(".categories").data("page")-1),e.preventDefault()}}).delegate(".next",{click:function(e){h(d.find(".categories").data("page")+1),e.preventDefault()}}).delegate(".category",{click:function(t){d.find(".categories .current").removeClass("current"),g(e.trim(e(this).addClass("current").text())),t.preventDefault()}}).delegate(".page",{click:function(t){d.find(".pages .current").removeClass("current"),p(parseInt(e(this).addClass("current").text(),10)-1),t.preventDefault()}}).delegate(".face",{click:function(i){d.hide(),t.insertText(e(this).children("img").prop("alt")).focus(),i.preventDefault()}}),e.getJSON("https://api.weibo.com/2/emotions.json?callback=?",{source:i.appKey,language:i.language},function(t){var i,a,f=t.data;e("#sina-emotion").html('<div class="switch"><a href="#" class="prev">&laquo;</a><a href="#" class="next">&raquo;</a></div><ul class="categories"></ul><ul class="faces"></ul><ul class="pages"></ul>');for(var h=0,g=f.length;h<g;++h)a=(i=f[h]).category||l,o[a]||(o[a]=[],c.push(a)),o[a].push({icon:i.icon,phrase:i.phrase}),r[i.phrase]=i.icon;for(var p=0,d=s.length;p<d;++p)s[p]();c.length<=5&&m.children(".switch").remove(),u=n})}else f&&s.push(f);else f&&f()}function h(t){for(var i="",a=c.length,n=Math.ceil(a/5),s=e("#sina-emotion").find(".categories"),o=s.data("category")||l,r=5*(t=(t+n)%n);r<a&&r<5*(t+1);++r)i+='<li class="item"><a href="#" class="category'+(o===c[r]?" current":"")+'">'+c[r]+"</a></li>";s.data("page",t).html(i)}function g(t){e("#sina-emotion").find(".categories").data("category",t),p(0),function(){var t="",a=i.rows,n=e("#sina-emotion"),s=n.find(".categories").data("category"),c=o[s].length;if(c>a){for(var r=0,l=Math.ceil(c/a);r<l;++r)t+='<li class="item"><a href="#" class="page'+(0===r?" current":"")+'">'+(r+1)+"</a></li>";n.find(".pages").html(t).show()}else n.find(".pages").hide()}()}function p(t){for(var a,n="",s=i.rows,c=e("#sina-emotion"),r=c.find(".categories").data("category"),l=o[r],u=(t=t||0)*s,f=l.length;u<f&&u<(t+1)*s;++u)n+='<li class="item"><a href="#" class="face"><img class="sina-emotion" src="'+(a=l[u]).icon+'" alt="'+a.phrase+'" /></a></li>';c.find(".faces").html(n)}e.fn.sinaEmotion=function(i){var a=e(this).last(),n=a.offset();return i=i||function(){return a.parents("form").find("textarea, input[type=text]").eq(0)},a.is(":visible")&&(t="function"==typeof i?i.call(a):e(i),f(function(){g(l),h(0)}),e("#sina-emotion").css({top:n.top+a.outerHeight()+5,left:n.left}).show()),this},e.fn.parseEmotion=function(){var t=e(this);return f(function(){t.each(function(){var t=e(this),i=t.html();i=i.replace(/<.*?>/g,function(e){return e=(e=e.replace("[","&#91;")).replace("]","&#93;")}).replace(/\[[^\[\]]*?]/g,function(e){var t=r[e];return t?'<img class="sina-emotion" src="'+t+'" alt="'+e+'" />':e}),t.html(i)})}),this},e.fn.insertText=function(e){return this.each(function(){if("INPUT"===this.tagName||"TEXTAREA"===this.tagName)if(document.selection){this.focus();var t=document.selection.createRange();t.text=e,t.collapse(),t.select()}else if(void 0!==this.selectionStart){var i=this.selectionStart,a=this.selectionEnd;this.value=this.value.substring(0,i)+e+this.value.substring(a,this.value.length),this.selectionStart=this.selectionEnd=i+e.length}else this.value+=e}),this},e.fn.sinaEmotion.options={rows:72,language:"cnname",appKey:"1362404091"}});